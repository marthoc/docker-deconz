services:
  - docker
language: shell
os: linux
dist: xenial
env:
  global:
    - secure: "Dj7E91VNm5GxY0vMGXdM0fKUtTLtBKWIqC3eZJq4YsUXZTCCA7AKCqa7iD7CksHgcvn+vOYR1ijXou5kWK8HuIcTX7ipSavaOWljPIxqopTvP0cVFmHO2ViRYzU11kRQMIDOi6eEQ2wlqdGpkIxD4aPUYcNjM+A4T5W2ObCSMa9YN9/1GEguTQ4H5KEVORutJMpS60IB9qf8t1UH2NOstOy2xXKoYCwcUZOm5CoTjQhCWROnuM1JWMTX0f7QPbxn+GhAVsiSnpJYTTQxaH6XzGSh5OW0aduQweMk0vNkGpmnFUqCHs26ti7Jte8cIRMF7Hvk5TlsxjRp4xKG54jMD/Ai8qhsGieynwY0+sERVcoYBPhEBpK98THOUeCdKWmbd8PTpV3NcucHgn7cp8CWU04v6guT8u0AdwOnOXfhJ7K4U4VpLgw6LfE+Qf0bXrYqAdyZOWKslk5C6W+s5mRwFprmUmq7yfeGQ/QS8ND3iaMfB/EUc3486lyLgV8KmuUCNRDKzv6db4NI8ov9Nks91b3vouAa1/nTwWFOCgGl0BBCpZGJ6LYLvCyEviA+XXgkAgoA7SV0Y7A0Isvqu7WgsOhSaVa8J6MUuznN7ETE9InrdbPVmzUO+Y5lMYiLJhaRysweG69IO+Uv8BOruRAh6zbPz6n5lZlD4uzY7gDQGOU="
    - secure: "iMERpUa2vSIsPZs/WdjgtDmkDd+64TuzGnDIFuI/FAOaXfh2Jx1Srs/xuLMy/XSd+vEy+j0kWVdJCDoPZl7ymPlebqNfR7NjLiR6EM0EmxSyqZCMo/MnXJ3mFKsaJARdRolpEw17sumo8Rwqo5o01pNsZxGP9TDmTSVSODylAWILPkfekWAuVI3Dhjuxzvk/Xg35t7S8a0DIuOgXUm+hEumti4PrFFPrSy4hthTON73WTy1czuaQlafqET/jgzGy9/zEveW+Xflxt8XhJF6Uc/4DEIKVLf0Q5lkrOq1poJQsDrug8X6XbXPKTkrOG+EM9qiZszT+wup0DMck9r/KGOfGIPAkAki2Tj1HpC0vF5bFRi0j71zMiXOClPQFwJkuHDz1z4xvBF7EnfKgxaelHuHXjaVqIV2LW7XJIO3RMX91dCKHvV+hneaiUfKVLI3oI9hUVDYM+ip5+iuwbewhs9Nel9A1estbwa2WvgoppzAVxnGJB7w8PUFCH34CGXB87CK+EvSoMc9PjcFo6vhl88AyYgZCY3Oi+i3y49hXO4VDeh4Ip3NftlLWgrRDIqFxCJH8BLT0uoTtaMb3DVy44UthmzNll4FpVCvBGdsLNzaPAW3BsXCTcnj8W8xBzGCWOWH3U7aBXThlSuz4d6aejyrtSq65rxzotxjBdAKOk2I="
install:
  - sudo apt-get install -y jq
  - wget https://github.com/estesp/manifest-tool/releases/download/v1.0.3/manifest-tool-linux-amd64 -O manifest-tool
  - chmod +x manifest-tool
script:
# Parse variables
  - BUILD_VERSION=$(cat version.json | jq -r .version)
  - BUILD_CHANNEL=$(cat version.json | jq -r .channel)
# Login to Docker Hub (to avoid rate-limiting on builds)
  - docker login -u $DOCKER_LOGIN -p $DOCKER_TOKEN
# Build amd64
  - docker build --build-arg VERSION=$BUILD_VERSION --build-arg CHANNEL=$BUILD_CHANNEL -t "marthoc/deconz:amd64" ./amd64
# Build armv7
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset
  - docker build --build-arg VERSION=$BUILD_VERSION --build-arg CHANNEL=$BUILD_CHANNEL -t "marthoc/deconz:armv7" ./armv7
# Build arm64
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset
  - docker build --build-arg VERSION=$BUILD_VERSION --build-arg CHANNEL=$BUILD_CHANNEL -t "marthoc/deconz:arm64" ./arm64
after_success:
# Tag and push test images after a successful build
  - docker tag marthoc/deconz:amd64 marthoc/deconz:amd64-test
  - docker push marthoc/deconz:amd64-test
  - docker tag marthoc/deconz:armv7 marthoc/deconz:armv7-test
  - docker push marthoc/deconz:armv7-test
  - docker tag marthoc/deconz:arm64 marthoc/deconz:arm64-test
  - docker push marthoc/deconz:arm64-test
# If merged to master, tag and push production images and update manifests
  - >
    if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
      docker tag marthoc/deconz:amd64 marthoc/deconz:amd64-$BUILD_VERSION
      docker push marthoc/deconz:amd64
      docker push marthoc/deconz:amd64-$BUILD_VERSION
      docker tag marthoc/deconz:armv7 marthoc/deconz:armv7-$BUILD_VERSION
      docker tag marthoc/deconz:armv7 marthoc/deconz:armhf
      docker tag marthoc/deconz:armv7 marthoc/deconz:armhf-$BUILD_VERSION
      docker push marthoc/deconz:armv7
      docker push marthoc/deconz:armv7-$BUILD_VERSION
      docker push marthoc/deconz:armhf
      docker push marthoc/deconz:armhf-$BUILD_VERSION
      docker tag marthoc/deconz:arm64 marthoc/deconz:arm64-$BUILD_VERSION
      docker tag marthoc/deconz:arm64 marthoc/deconz:aarch64
      docker tag marthoc/deconz:arm64 marthoc/deconz:aarch64-$BUILD_VERSION
      docker push marthoc/deconz:arm64
      docker push marthoc/deconz:arm64-$BUILD_VERSION
      docker push marthoc/deconz:aarch64
      docker push marthoc/deconz:aarch64-$BUILD_VERSION
      ./manifest-tool --username $DOCKER_LOGIN --password $DOCKER_PASS push from-args \
        --platforms linux/amd64,linux/arm/v7,linux/arm64 \
        --template marthoc/deconz:ARCHVARIANT-$BUILD_VERSION \
        --target marthoc/deconz:latest
      ./manifest-tool --username $DOCKER_LOGIN --password $DOCKER_PASS push from-args \
        --platforms linux/amd64,linux/arm/v7,linux/arm64 \
        --template marthoc/deconz:ARCHVARIANT-$BUILD_VERSION \
        --target marthoc/deconz:$BUILD_VERSION
      if [ "$BUILD_CHANNEL" == "stable" ]; then
        ./manifest-tool --username $DOCKER_LOGIN --password $DOCKER_PASS push from-args \
          --platforms linux/amd64,linux/arm/v7,linux/arm64 \
          --template marthoc/deconz:ARCHVARIANT-$BUILD_VERSION \
          --target marthoc/deconz:stable
      fi
    fi
    
